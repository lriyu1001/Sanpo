<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIãŠæ•£æ­©ãƒŠãƒ“ (å®Œå…¨ç‰ˆ)</title>
    <style>
        /* ã‚¢ãƒ—ãƒªé¢¨ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š */
        :root {
            --primary: #4facfe;
            --secondary: #00f2fe;
            --text: #333;
            --bg: #fdfbfb;
        }
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }
        .container {
            background-color: white;
            width: 100%;
            max-width: 500px;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            height: fit-content;
        }
        h1 {
            text-align: center;
            margin: 0 0 20px 0;
            font-size: 1.4rem;
            color: #444;
        }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
        .form-group { margin-bottom: 15px; }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
            font-size: 0.9rem; 
            color: #555;
            display: flex;
            justify-content: space-between;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 1rem;
            box-sizing: border-box;
            background-color: #fafafa;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            background-color: #fff;
        }
        textarea { height: 80px; resize: vertical; }

        /* APIã‚­ãƒ¼å–å¾—ãƒªãƒ³ã‚¯ */
        .api-link {
            font-size: 0.8rem;
            color: var(--primary);
            text-decoration: none;
        }

        /* çµŒç”±åœ°ã‚¨ãƒªã‚¢ */
        .waypoint-item {
            display: flex;
            gap: 5px;
            margin-bottom: 8px;
        }
        .remove-btn {
            background: #ffdede;
            color: #ff4757;
            border: none;
            border-radius: 8px;
            width: 45px;
            cursor: pointer;
            font-weight: bold;
        }
        .add-btn {
            width: 100%;
            padding: 8px;
            background: #f0f4f8;
            color: #555;
            border: 2px dashed #ccc;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .add-btn:hover { border-color: var(--primary); color: var(--primary); }

        /* ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ */
        .submit-btn {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 15px;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
            width: 100%;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }
        .submit-btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* çµæœè¡¨ç¤º */
        #result-area { display: none; margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; }
        .result-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 10px; color: #2c3e50; }
        .result-desc { font-size: 0.95rem; line-height: 1.6; color: #555; margin-bottom: 20px; }
        
        .map-btn {
            display: block;
            background-color: #4285F4;
            color: white;
            text-align: center;
            text-decoration: none;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* ãƒ­ãƒ¼ãƒ‰ä¸­ */
        .loader {
            display: none;
            text-align: center;
            margin-top: 20px;
            color: #888;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸš¶ AIãŠæ•£æ­©ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼</h1>

    <div class="form-group" style="background: #f8f9fa; padding: 10px; border-radius: 10px;">
        <label>
            Gemini APIã‚­ãƒ¼ 
            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="api-link">ğŸ”‘ ã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹</a>
        </label>
        <input type="password" id="api-key" placeholder="ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„">
    </div>

    <div class="form-group">
        <label>å‡ºç™ºåœ°</label>
        <input type="text" id="start" placeholder="ä¾‹ï¼šæ±äº¬é§…">
    </div>

    <div class="form-group">
        <label>çµŒç”±åœ° (å¯„ã‚ŠãŸã„å ´æ‰€)</label>
        <div id="waypoints-list"></div>
        <button class="add-btn" onclick="addWaypoint()">ï¼‹ çµŒç”±åœ°ã‚’è¿½åŠ </button>
    </div>

    <div class="form-group">
        <label>ç›®çš„åœ°</label>
        <input type="text" id="end" placeholder="ä¾‹ï¼šä¸Šé‡å…¬åœ’">
    </div>

    <div class="form-group">
        <label>ã©ã‚“ãªæ•£æ­©ã«ã™ã‚‹ï¼Ÿ</label>
        <textarea id="pref" placeholder="ä¾‹ï¼š30åˆ†ãã‚‰ã„ã§ã€é™ã‹ãªè£é“ã‚’é€šã£ã¦ã‚«ãƒ•ã‚§ã«å¯„ã‚ŠãŸã„ã€‚"></textarea>
    </div>

    <button class="submit-btn" onclick="generateRoute()">ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ âœ¨</button>

    <div class="loader" id="loader">
        AIãŒæœ€é©ãªãƒ«ãƒ¼ãƒˆã‚’è€ƒãˆã¦ã„ã¾ã™...<br>
        (ä½¿ãˆã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’è‡ªå‹•æ¤œç´¢ä¸­ ğŸ¤–)
    </div>

    <div id="result-area">
        <div class="result-title" id="res-title"></div>
        <div class="result-desc" id="res-desc"></div>
        <a href="#" target="_blank" class="map-btn" id="map-link">ğŸ“ Googleãƒãƒƒãƒ—ã§è¦‹ã‚‹</a>
    </div>
</div>

<script>
    // çµŒç”±åœ°ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    function addWaypoint() {
        const div = document.createElement('div');
        div.className = 'waypoint-item';
        div.innerHTML = `
            <input type="text" class="wp-input" placeholder="çµŒç”±åœ°ã‚’å…¥åŠ›">
            <button class="remove-btn" onclick="this.parentElement.remove()">Ã—</button>
        `;
        document.getElementById('waypoints-list').appendChild(div);
    }

    // â˜…ã“ã“ãŒä¿®æ­£ç‚¹ï¼šä½¿ãˆã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’è‡ªå‹•ã§æ¢ã™é–¢æ•°â˜…
    async function findWorkingModel(apiKey) {
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
            const data = await response.json();
            
            if (data.error) throw new Error(data.error.message);

            // 'generateContent' ã«å¯¾å¿œã—ã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’æ¢ã™
            const models = data.models || [];
            // å„ªå…ˆé †ä½: flash > pro > ãã®ä»–
            const validModel = models.find(m => m.supportedGenerationMethods.includes("generateContent") && m.name.includes("flash")) 
                            || models.find(m => m.supportedGenerationMethods.includes("generateContent") && m.name.includes("pro"))
                            || models.find(m => m.supportedGenerationMethods.includes("generateContent"));

            if (!validModel) throw new Error("ä½¿ãˆã‚‹ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            return validModel.name.replace('models/', ''); // åå‰ã ã‘è¿”ã™

        } catch (e) {
            console.error(e);
            return "gemini-1.5-flash"; // æœ€çµ‚æ‰‹æ®µ
        }
    }

    // ãƒ¡ã‚¤ãƒ³å‡¦ç†
    async function generateRoute() {
        const apiKey = document.getElementById('api-key').value.trim();
        const start = document.getElementById('start').value;
        const end = document.getElementById('end').value;
        const pref = document.getElementById('pref').value;
        
        // çµŒç”±åœ°ã‚’é…åˆ—ã«ã™ã‚‹
        const wps = Array.from(document.querySelectorAll('.wp-input'))
                        .map(i => i.value).filter(v => v.trim() !== "");

        if (!apiKey) { alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
        if (!start || !end) { alert("å‡ºç™ºåœ°ã¨ç›®çš„åœ°ã¯å¿…é ˆã§ã™"); return; }

        document.getElementById('loader').style.display = 'block';
        document.getElementById('result-area').style.display = 'none';

        try {
            // 1. ä½¿ãˆã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’æ¢ã™
            const modelName = await findWorkingModel(apiKey);
            console.log("Using model:", modelName);

            // 2. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
            const prompt = `
                ã‚ãªãŸã¯æ•£æ­©ã®ãƒ—ãƒ­ã§ã™ã€‚ä»¥ä¸‹ã®æ¡ä»¶ã§ãƒ«ãƒ¼ãƒˆã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚
                å‡ºç™º: ${start}, åˆ°ç€: ${end}
                å¿…é ˆçµŒç”±åœ°: ${wps.join(', ') || 'ãªã—'}
                è¦æœ›: ${pref}
                
                ã‚¿ã‚¹ã‚¯:
                1. è¦æœ›ã«åˆã‚ã›ã¦ã€Googleãƒãƒƒãƒ—ã§æ¤œç´¢å¯èƒ½ãªã€Œå…·ä½“çš„ãªå ´æ‰€(çµŒç”±åœ°)ã€ã‚’2ã€œ4ã¤é¸å®šã—ã¦ãã ã•ã„ï¼ˆå¿…é ˆçµŒç”±åœ°ã‚’å«ã‚€ï¼‰ã€‚
                2. ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆMarkdownä¸è¦ï¼‰ã€‚
                {
                    "title": "ãƒ«ãƒ¼ãƒˆå",
                    "description": "é­…åŠ›ã®è§£èª¬(100æ–‡å­—ç¨‹åº¦)",
                    "waypoints": ["çµŒç”±åœ°1", "çµŒç”±åœ°2", ...]
                }
            `;

            // 3. APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await res.json();
            if (data.error) throw new Error(data.error.message);

            // 4. çµæœè¡¨ç¤º
            const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
            const result = JSON.parse(text);

            document.getElementById('res-title').textContent = result.title;
            document.getElementById('res-desc').textContent = result.description;

            // Googleãƒãƒƒãƒ—URLç”Ÿæˆ
            const baseUrl = "https://www.google.com/maps/dir/?api=1";
            const origin = `&origin=${encodeURIComponent(start)}`;
            const dest = `&destination=${encodeURIComponent(end)}`;
            
            let wpParam = "";
            if (result.waypoints && result.waypoints.length > 0) {
                wpParam = `&waypoints=${result.waypoints.map(w => encodeURIComponent(w)).join('|')}`;
            }

            // æ­©ããƒ¢ãƒ¼ãƒ‰
            document.getElementById('map-link').href = baseUrl + origin + dest + wpParam + "&travelmode=walking";
            document.getElementById('result-area').style.display = 'block';

        } catch (e) {
            alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }
</script>

</body>
</html>
